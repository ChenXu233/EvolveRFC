name: Nightly RFC Daemon

on:
  # æ¯æ—¥UTC 0:00è§¦å‘
  schedule:
    - cron: '0 0 * * *'
  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      mode:
        description: 'è¿è¡Œæ¨¡å¼'
        required: false
        default: 'random'
        type: choice
        options:
          - random
          - audit
          - pre_discussion
          - creative

env:
  MINIMAX_API_KEY: ${{ secrets.MINIMAX_API_KEY }}

jobs:
  nightly-rfc:
    runs-on: ubuntu-latest
    if: github.repository_owner == 'your-username'  # æ›¿æ¢ä¸ºä½ çš„ç”¨æˆ·å

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # éœ€è¦å®Œæ•´å†å²ç”¨äºä»£ç åˆ†æ

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Setup uv
        uses: astral-sh/setup-uv@v4

      - name: Install dependencies
        run: uv sync

      - name: Run Nightly Daemon
        id: nightly
        run: |
          echo "ğŸš€ å¯åŠ¨å¤œé—´å®ˆæŠ¤è¿›ç¨‹ï¼ˆGitHub Actionæ¨¡å¼ï¼‰..."

          # æ ¹æ®è¾“å…¥å‚æ•°æˆ–éšæœºé€‰æ‹©æ¨¡å¼
          MODE="${{ github.event.inputs.mode || 'random' }}"
          uv run python -m evolve_rfc.nightly.daemon --mode "$MODE"

          # æ£€æŸ¥æ˜¯å¦æœ‰è¾“å‡ºæ–‡ä»¶
          if ls nightly_output/*.md 1> /dev/null 2>&1; then
            echo "âœ… å‘ç°è¾“å‡ºæ–‡ä»¶"

            # è·å–è¾“å‡ºæ–‡ä»¶å
            OUTPUT_FILE=$(ls -t nightly_output/*.md | head -1)
            echo "output_file=$OUTPUT_FILE" >> $GITHUB_OUTPUT

            # è¯»å–è¾“å‡ºå†…å®¹ç”¨äºé€šçŸ¥
            echo "content=$(cat $OUTPUT_FILE | head -c 200)..." >> $GITHUB_OUTPUT
          else
            echo "ğŸ“­ å½“æ—¥æ— è¾“å‡ºï¼ˆé™é»˜ç»“æŸï¼‰"
          fi

      - name: Create Pull Request (if output exists)
        if: steps.nightly.outputs.output_file != ''
        uses: peter-evans/create-pull-request@v7
        with:
          token: ${{ secrets.GH_TOKEN }}
          commit-message: "ğŸ¤– Nightly: $(date +%Y-%m-%d)"
          title: "ğŸ“‹ RFC Nightly Output - $(date +%Y-%m-%d)"
          body: |
            å¤œé—´å®ˆæŠ¤è¿›ç¨‹è¾“å‡ºç»“æœ

            ## æ¦‚è§ˆ
            ${{ steps.nightly.outputs.content }}

            ç”± @github-actions[bot] è‡ªåŠ¨ç”Ÿæˆ
          branch: nightly/$(date +%Y-%m-%d)
          delete-branch: true

      - name: Send Notification (Slack/Discord)
        if: steps.nightly.outputs.output_file != ''
        run: |
          # Slacké€šçŸ¥ç¤ºä¾‹
          curl -X POST -H 'Content-type: application/json' \
            --data '{"text":"ğŸŒ™ å¤œé—´å®ˆæŠ¤è¿›ç¨‹å·²ç”Ÿæˆæ–°çš„RFCè¾“å‡ºï¼Œè¯·æŸ¥çœ‹ï¼šhttps://github.com/${{ github.repository }}/pull/new/nightly/$(date +%Y-%m-%d)"}' \
            ${{ secrets.SLACK_WEBHOOK_URL }}
